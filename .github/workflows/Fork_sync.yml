name: Upstream Sync

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: "0 2 * * *" # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è¿è¡Œ

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout target repo
        uses: actions/checkout@v4

      # 2. åŒæ­¥æ ¸å¿ƒæ­¥éª¤
      - name: Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          # ğŸ‘‡ è¿™é‡Œæˆ‘å·²ç»å¸®ä½ å¡«å¥½äº† imzyb/MiSub ğŸ‘‡
          upstream_sync_repo: imzyb/MiSub
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          test_mode: false
          
          # ğŸ‘‡ å¼ºåŠ›å‚æ•°ï¼šä¸“æ²»å„ç§åŒæ­¥æŠ¥é”™ï¼Œå¼ºåˆ¶æ‹‰å–ä½œè€…ä»£ç 
          upstream_sync_args: '--allow-unrelated-histories --force'

      # 3. æ£€æŸ¥åŒæ­¥ç»“æœ
      - name: Sync check
        if: failure()
        run: |
          echo "[Error] åŒæ­¥å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥åŸä½œè€…ä»“åº“ (imzyb/MiSub) æ˜¯å¦ä¾ç„¶å­˜åœ¨ã€‚"
          exit 1

      # 4. è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼ˆåªä¿ç•™æœ€è¿‘3å¤©ï¼‰
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 3
